<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClaimRight - Payments</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --gradient-primary: linear-gradient(90deg, #4e73df, #36b9cc);
      --gradient-orange: linear-gradient(90deg, #ff7e5f, #feb47b);
      --text-dark: #222;
      --text-muted: #6c757d;
      --bg-light: #f8f9fa;
    }

    .main-content-container {
      min-height: 100vh;
    }

    /* Security info modal */
    .secure-modal {
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      z-index: 1080; /* Higher than backdrop */
    }

    .secure-modal-header {
      background: var(--gradient-primary);
      color: white;
      font-weight: bold;
      padding: 15px 20px;
    }

    .secure-modal-footer {
      padding: 12px 20px;
    }

    /* Text + icons inside modal */
    .secure-modal .modal-body p {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      line-height: 1.5;
      font-size: 15px;
    }

    .secure-icon {
      font-size: 1.3rem; /* larger icons */
      margin-right: 10px;
      flex-shrink: 0;
    }

    /* Modal Title Styling */
    .secure-modal-header .modal-title {
      font-weight: bold;
      text-align: center;
      flex-grow: 1;
    }

    /* Secure Payment Info List */
    .secure-list li {
      display: flex;
      align-items: flex-start;
      margin-bottom: 12px;
      line-height: 1.5;
      font-size: 15px;
    }

    .secure-icon {
      font-size: 1.3rem;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .floating-page-btn {
      position: fixed;
      z-index: 1000;
      padding: 12px 20px;
      border-radius: 50px;
      border: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .floating-help-nav-btn {
      bottom: 50px;
      right: 30px;
      background: var(--gradient-primary);
    }

    .floating-secure-nav-btn {
      bottom: 150px;
      right: 30px;
      background: var(--gradient-orange);
    }

    .floating-page-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    /* Payment Card Styles */
    .secure-modal {
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .secure-modal-header {
      background: var(--gradient-primary);
      color: white;
      font-weight: bold;
      padding: 15px 20px;
    }

    .payment-card {
      border-radius: 15px;
      background-color: #fff;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      padding: 25px;
      margin-top: 20px;
    }

    #payment-element {
      padding: 15px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      background-color: #f8f9fa;
    }

    #submit-payment {
      font-weight: 600;
      padding: 12px;
      font-size: 1rem;
      border-radius: 8px;
      transition: 0.2s ease, transform 0.2s ease;
    }

    #submit-payment:hover {
      background: #36b9cc;
      transform: translateY(-2px);
    }

    /* Testing table */
    /* Table styling */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      background-color: #1e1e2f; /* dark background */
      color: #f8f9fa;
      border-radius: 8px;
      overflow: hidden;
    }

    table thead {
      background-color: #343a40;
      color: #fff;
    }

    table thead th {
      padding: 0.5rem 0.75rem;
      text-align: left;
      font-weight: 600;
    }

    table tbody tr {
      border-bottom: 1px solid #495057;
      cursor: pointer;
    }

    table tbody tr:last-child {
      border-bottom: none;
    }

    table tbody td {
      padding: 0.5rem 0.75rem;
      transition: background-color 0.2s;
    }

    table tbody tr:hover td {
      background-color: #495057;
    }

    /* Animations */
    .fade-in {
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 1s ease forwards;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Modal backdrop fix */
    .modal-backdrop {
      z-index: 1040 !important; /* Lower than modal */
    }
    
    .modal {
      z-index: 1050 !important;
    }

    /* Loading overlay */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
  </style>

  <link rel="icon" href="/Front_End/assets/images/Leonardo_Phoenix_09_Design_a_modern_clean_logo_for_a_Lost_and_0.jpg" type="image">
</head>
<body> 
  <div id="navbar-container"></div> 

  <div class="main-content-container fade-in">
    <!-- Trigger Button -->
    <form id="payment-trigger-form" class="p-5">
        <div class="mb-3">
          <label for="amount-input" class="form-label">Payment Amount</label>
          <input type="number" name="amount" id="amount-input" class="form-control" value="" placeholder="Enter amount">
        </div>
        <button type="button" class="btn btn-primary" onclick="openPaymentModal()">Pay Test Reward</button>
    </form>

    <!-- Payment Modal -->
    <div class="modal fade" id="securePaymentModal" tabindex="-1" aria-labelledby="securePaymentLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content secure-modal">

          <!-- Header -->
          <div class="modal-header secure-modal-header d-flex justify-content-between align-items-center">
            <i class="bi bi-shield-lock-fill fs-4"></i>
            <h5 class="modal-title mx-auto" id="securePaymentLabel">Payment</h5>
            <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <!-- Body -->
          <div class="modal-body">
            <form id="payment-form">
              <!-- Stripe Payment Element (new unified UI) -->
              <div id="payment-element" class="mb-3"></div>

              <!-- Errors -->
              <div id="payment-errors" role="alert" class="text-danger mb-3"></div>

              <!-- Submit Button -->
              <button id="submit-payment" class="btn btn-primary w-100 mt-2">Pay <span id="payment-amount"></span></button>
            </form>
          </div>

          <!-- Footer -->
          <div class="modal-footer secure-modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <a href="/Front_End/html/chat-page.html" class="btn btn-primary">
              <i class="bi bi-chat-dots-fill"></i> Contact Support
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Secure Payment Info Modal -->
  <div class="modal fade" id="securePaymentDetailModal" tabindex="-1" aria-labelledby="securePaymentLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content secure-modal">
        <!-- Header -->
        <div class="modal-header secure-modal-header d-flex justify-content-between align-items-center">
          <i class="bi bi-shield-lock-fill fs-4"></i>
          <h5 class="modal-title mx-auto" id="securePaymentLabel">
            Secure Payment Information
          </h5>
          <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <!-- Body -->
        <div class="modal-body">
            <ul class="list-unstyled secure-list">
              <li>
                <i class="bi bi-shield-lock-fill secure-icon text-primary"></i>
                <strong>SSL Encryption:</strong> All transactions are encrypted using SSL (Secure Socket Layer) to protect your sensitive information.
              </li>
              <li>
                <i class="bi bi-lock-fill secure-icon text-success"></i>
                <strong>No Storage of Card Data:</strong> We never store your credit or debit card details on our servers.
              </li>
              <li>
                <i class="bi bi-shield-check secure-icon text-info"></i>
                <strong>Trusted Providers:</strong> Payments are processed via leading gateways such as <strong>Stripe</strong> and <strong>PayPal</strong>.
              </li>
              <li>
                <i class="bi bi-credit-card-2-front-fill secure-icon text-warning"></i>
                <strong>Multiple Payment Options:</strong> Pay safely with Visa, MasterCard, or digital wallets.
              </li>
              <li>
                <i class="bi bi-person-check-fill secure-icon text-danger"></i>
                <strong>Buyer Protection:</strong> You are protected in case of disputes or failed transactions.
              </li>
            </ul>
            <p class="text-muted small mt-2">
              Have questions? Our support team is available 24/7 to assist you.
            </p>

            <h6 class="mt-4 text-center fw-bold">Test Card Numbers (click to copy)</h6>
            <table id="test-cards">
              <thead>
                <tr>
                  <th>Purpose</th>
                  <th>Card Number</th>
                  <th>Expiry Date</th>
                  <th>CVC</th>
                  <th>ZIP</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Success</td>
                  <td>4242 4242 4242 4242</td>
                  <td>12/34</td>
                  <td>123</td>
                  <td>12345</td>
                </tr>
                <tr>
                  <td>Card declined</td>
                  <td>4000 0000 0000 0002</td>
                  <td>12/34</td>
                  <td>123</td>
                  <td>12345</td>
                </tr>
                <tr>
                  <td>Insufficient funds</td>
                  <td>4000 0000 0000 9995</td>
                  <td>12/34</td>
                  <td>123</td>
                  <td>12345</td>
                </tr>
                <tr>
                  <td>CVC failure</td>
                  <td>4000 0000 0000 0101</td>
                  <td>12/34</td>
                  <td>123</td>
                  <td>12345</td>
                </tr>
                <tr>
                  <td>Authentication required (3D Secure)</td>
                  <td>4000 0025 0000 3155</td>
                  <td>12/34</td>
                  <td>123</td>
                  <td>12345</td>
                </tr>
            </table>
        </div>

        <!-- Footer -->
        <div class="modal-footer secure-modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <a href="/Front_End/html/chat-page.html" class="btn btn-primary">
            <i class="bi bi-chat-dots-fill"></i> Contact Support
          </a>
        </div>
      </div>
    </div>
  </div>

  <button class="floating-page-btn floating-help-nav-btn" onclick="openFloatOptionHelp()">
    <i class="bi bi-question-circle-fill"></i>&nbsp;&nbsp;Need Help?
  </button>

  <button class="floating-page-btn floating-secure-nav-btn" onclick="openFloatOptionSecure()">
    <i class="bi bi-shield-lock-fill"></i>&nbsp;&nbsp;Secure Payment Info
  </button>

  <div id="loadingOverlay">
    <div style="padding: 20px 30px; border-radius: 10px; text-align: center; background: white;">
        <div class="spinner" 
            style="width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid #3498db; border-radius: 50%; margin: 0 auto; animation: spin 1s linear infinite;">
        </div>
        <p style="margin-top: 10px; font-size: 16px;">Loading...</p>
    </div>
  </div>

  <div id="login-popup-container"></div>
  <div id="edit-profile-container"></div>
  <div id="footer-container"></div>    
  <div id="loading-animation"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://js.stripe.com/v3/"></script>

  <script>
    const API_PAYMENTS = 'http://localhost:8080/claimright/payments';
    let stripe, elements, paymentElement, clientSecret;

    document.addEventListener("DOMContentLoaded", async () => {
      stripe = Stripe("pk_test_51S5j4qQyZBVCuvZZ2fVhQ77PPHSJpucR4pgZvAeVZ6zJMSzwhFkV3ZJyvpJT5iB6fTCoZl391v8vYMI8D3hJGGXt007hyw2a4j");

      const modalEl = document.getElementById('securePaymentModal');
      modalEl.addEventListener('shown.bs.modal', async () => {
        await createPaymentIntent();
        if (!clientSecret) return;

        if (!elements) {
          elements = stripe.elements({ clientSecret });
        }

        if (!paymentElement) {
          // Force country to US for testing to avoid processing errors
          paymentElement = elements.create("payment", {
            fields: { billingDetails: "auto" },
            defaultValues: { billingDetails: { address: { country: "US" } } }
          });
          paymentElement.mount("#payment-element");
        }
      });

      document.getElementById('payment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await pay();
      });
      
      // Copy cell content on click with small toast
      document.querySelectorAll("#test-cards tbody td").forEach(td => {
        td.addEventListener("click", () => {
          navigator.clipboard.writeText(td.textContent).then(() => {
            Swal.fire({
              toast: true,               // small toast style
              position: 'top-end',       // top right corner
              icon: 'success',
              title: `"${td.textContent}" copied`,
              showConfirmButton: false,
              timer: 1000,
              timerProgressBar: true
            });
          });
        });
      });
    });

    async function createPaymentIntent() {
      const overlay = document.getElementById("loadingOverlay");
      overlay.style.display = "flex"; // show loading overlay

      try {
        const token = localStorage.getItem("accessToken");
        const userJsonStr = localStorage.getItem("loggedInUser");
        const userJson = JSON.parse(userJsonStr);

        const amountInput = document.getElementById('amount-input').value;
        const payload = {
          amount: parseFloat(amountInput) * 100, // Convert to cents
          type: "REWARD",
          payerId: userJson.userId,
          receiverId: null,
          lostItemId: null,
          foundItemId: null
        };

        const response = await fetch(`${API_PAYMENTS}/create-intent`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error("Failed to create payment intent");
        const data = await response.json();
        clientSecret = data.clientSecret;

      } catch (err) {
        console.error(err);
        Swal.fire({ icon: "error", title: "Error", text: err.message || "Payment initialization failed" });
      } finally {
        overlay.style.display = "none"; // hide loading overlay
      }
    }
      
    async function pay() {
      const overlay = document.getElementById("loadingOverlay");
      overlay.style.display = "flex"; // show loading overlay

      try {
        if (!clientSecret) throw new Error("Payment not initialized");

        // Validate first
        const { error: submitError } = await elements.submit();
        if (submitError) {
          Swal.fire({ icon: "error", title: "Validation failed", text: submitError.message });
          return;
        }

        // Confirm payment (stay on same page for test)
        const { error, paymentIntent } = await stripe.confirmPayment({
          elements,
          clientSecret,
          redirect: "if_required"
        });

        // Handle errors
        if (error) {
          let message = error.message || "Payment failed";
          switch (error.code) {
            case "card_declined": message = "Your card was declined."; break;
            case "insufficient_funds": message = "Your card has insufficient funds."; break;
            case "incorrect_cvc": message = "The CVC code is incorrect."; break;
            case "expired_card": message = "This card has expired."; break;
            case "processing_error": message = "A processing error occurred. Please try again."; break;
          }
          Swal.fire({ icon: "error", title: "Payment failed", text: message });
          return;
        }

        // Payment succeeded
        if (paymentIntent?.status === "succeeded") {
          Swal.fire({ icon: "success", title: "Payment successful", timer: 2000, showConfirmButton: false });
        } 
        else if (paymentIntent?.status === "requires_action") {
          Swal.fire({ icon: "info", title: "Authentication required", text: "Please complete 3D Secure authentication." });
        } 
        else {
          Swal.fire({ icon: "info", title: "Payment status", text: `Status: ${paymentIntent?.status}` });
        }

      } catch (err) {
        console.error(err);
        Swal.fire({ icon: "error", title: "Error", text: err.message || "Payment failed" });
      } finally {
        overlay.style.display = "none"; // hide overlay after completion
      }
    }

    function openPaymentModal() {
      const amount = document.getElementById('amount-input').value; // get input value
      if (!amount || amount <= 0) {
        Swal.fire({ icon: 'error', title: 'Invalid amount', text: 'Please enter a valid payment amount' });
        return;
      }

      const modal = new bootstrap.Modal(document.getElementById('securePaymentModal'));
      document.getElementById('payment-amount').textContent = `$${amount}`; // display in modal
      modal.show();
    }

    function openFloatOptionHelp() {
      window.location.href = "/Front_End/html/chat-page.html";
    }

    function openFloatOptionSecure() {
      const modal = new bootstrap.Modal(document.getElementById('securePaymentDetailModal'));
      modal.show();
    }
  </script>
</body>
</html>